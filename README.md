# sys-tools

Набор утилит для Ubuntu VPS в едином стиле (интерактивное меню на русском).  
Цель: быстро приводить свежие ноды в рабочее состояние и **видеть**, что именно меняется.

## Что умеет сейчас

- **Fail2ban**
  - установка
  - настройка SAFE (не трогает существующий `sshd.local`)
  - настройка FORCE (перезапись по эталону + бэкап)
  - отчёт: статус, jail `sshd`, ban list, правила f2b в nft/iptables

- **vnStat**
  - установка и включение сервиса
  - инициализация интерфейса (`vnstat -u -i <iface>`)
  - статистика (день/месяц/час/список интерфейсов)
  - live мониторинг (`vnstat -l`) и быстрый speed-срез (`vnstat -tr 5`)

- **Firewall / Ports (UFW)**
  - установка ufw
  - базовое включение (deny incoming, allow outgoing, allow ssh)
  - добавить/удалить правила
  - показать слушающие порты (ss)
  - SSH audit: **топ атакующих IP** (исправлено, считает IP, а не “последнее слово” строки)

- **RemnaWave**
  - обновить panel/node/subpage через `docker compose pull/down/up -d`

- **RemnaNode**
  - установка Docker + compose
  - установка Xray-core на хост (монтирование в контейнер)
  - DNS-check (проверка A-записи домена на IP сервера)
  - установка/настройка Caddy selfsteal
  - запуск и статус контейнеров

---

## Требования

- Ubuntu 22.04 / 24.04 (apt, systemd)
- доступ по SSH с правами `sudo`

---

## Установка (рекомендуемый способ)

Установка делает клон репозитория в `/opt/sys-tools` и создаёт команду:

- `/usr/local/bin/sys-tools` → `/opt/sys-tools/toolbox.sh`

Запуск одной командой:

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/vitalyor/sys-tools/main/install.sh)
```

Далее:

```bash
sys-tools
```

---

## Обновление

В меню есть пункт:

- **“Обновить sys-tools из репозитория”** (выполнит `git pull --rebase`)

При старте `sys-tools` также выполняется авто-проверка обновлений:

- если есть новые коммиты и нет локальных изменений, апдейт применится автоматически с перезапуском;
- если есть локальные изменения, автообновление пропускается (безопасно для твоих правок).

Также вручную:

```bash
cd /opt/sys-tools && git pull --rebase
```

---

## Важные замечания по безопасности

### 1) Fail2ban SAFE vs FORCE

- **SAFE**: если `/etc/fail2ban/jail.d/sshd.local` уже существует — **скрипт его не трогает**.
- **FORCE**: перезаписывает `sshd.local`, но перед этим делает бэкап `*.bak-YYYYmmdd-HHMMSS` и требует подтверждения.

### 2) Firewall (UFW)

Включать UFW без разрешения правильного SSH-порта — прямой способ потерять доступ.  
Поэтому при включении UFW скрипт **спрашивает SSH-порт** и предупреждает.

### 3) RemnaNode и порты

`NODE_PORT` — это служебный порт API ноды, но **это всё равно порт на хосте**, потому что контейнер работает в `network_mode: host`.

Если ты задашь `NODE_PORT=2222`, а SSH уже слушает `2222`, будет конфликт.  
Скрипт проверяет занятость порта и показывает, кто его слушает.

---

## Структура проекта

```
sys-tools/
  install.sh
  toolbox.sh
  lib/
    ui.sh         # единый вывод/подсказки/меню
    system.sh     # системные функции (apt, ssh unit, бэкапы)
    update.sh     # обновление из git
  plugins/
    fail2ban.sh
    vnstat.sh
    firewall.sh
    remnawave.sh
    remnanode.sh
```

---

## Быстрые сценарии

### 1) Поставить учёт трафика и посмотреть статистику

1. `sys-tools`
2. vnStat → **Установить vnStat**
3. vnStat → **Инициализировать интерфейс** (выбери `eth0/ens3/...`)
4. vnStat → **Показать статистику** → месяц

Полезно для проверки текущей скорости:

- vnStat → **Live мониторинг**
- vnStat → **Тест-срез скорости за 5 сек**

### 2) Включить UFW безопасно

1. `sys-tools`
2. Firewall / Ports → **Включить UFW**
3. Укажи реальный SSH-порт (22 или 2222/что у тебя)

### 3) Fail2ban без риска сломать “нестандартную” ноду

1. `sys-tools`
2. Fail2ban → **Настроить SAFE**
3. Отчёт/статистика

---

## Лицензия

Для личного использования/инфраструктуры. Если нужно оформить публичную лицензию — добавим отдельным файлом.
